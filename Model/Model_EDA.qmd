---
title: "Model_EDA"
format: html
editor: visual
---

# Spatial Temporal SVR result analysis

## Result for first 3 area

```{r}
top_msoa <- test_results %>%
  group_by(.data[[cscale]]) %>%
  summarise(total = sum(Actual)) %>%
  arrange(desc(total)) %>%
  slice(1:3) %>%
  pull(.data[[cscale]])

plot_subset <- test_results %>%
  filter(.data[[cscale]] %in% top_msoa)

ggplot(plot_subset, aes(x = time_date)) +
  geom_line(aes(y = Actual, group = .data[[cscale]], color = .data[[cscale]]), size = 0.5) +
  geom_line(aes(y = Predicted, group = .data[[cscale]], color = .data[[cscale]]), linetype = "dashed", size = 0.8) +
  facet_wrap(~.data[[cscale]], scales = "free_y", ncol = 1) +
  theme_minimal()
```

## Plot result

```{r}
analyse_final <- test_results%>%
  group_by(.data[[cscale]])%>%
  summarise(total_actual = sum(Actual), total_predicted = sum(Predicted))
analyse_final_all <- test_results%>%
  mutate(mse = (Actual - Predicted)^2)%>%
  left_join(londona_geom, by = cscale)%>%
  st_as_sf()

predicted_line <- test_results%>%
  group_by(time_date)%>%
  summarise(total_actual = sum(Actual), total_predicted = sum(Predicted))%>%
  ggplot(aes(x = time_date)) +
  geom_line(aes(y = total_actual, color = "Actual"), size = 0.5) +
  geom_line(aes(y = total_predicted, color = "Predicted"), linetype = "dashed", size = 0.8) +
  theme_minimal() +
  labs(title = "Total Actual vs Predicted Accidents Over Time", y = "Total Accidents", color = "Legend")
predicted_line
# ggsave(file = "Data/Layout/ST_SVR_result.png", predicted_line, width = 15, height = 6, dpi = 300)
```

## Residual

```{r}
mse_plot <- analyse_final_all%>%
  ggplot()+
  geom_line(aes(time_date, mse)) +
  theme_minimal() +
  labs(title = "MSE of SVR with Spatial Lag Over Time", x = "Time", y = "Mean Squared Error")
mse_plot
# ggsave(file = "Data/Layout/ST_SVR_mse.png", mse_plot, width = 15, height = 6, dpi = 300)
```

## Map

```{r}
library(tmap)
source('../utils/map_func.R')
spatial_error <- analyse_final_all %>%
  group_by(lad22cd) %>%
  summarise(
    avg_residual = mean(Actual - Predicted, na.rm = TRUE),
    geometry = st_union(geometry)) %>%
  st_as_sf()

error_map <- tm_basemap("CartoDB.Positron") +
  tm_shape(spatial_error) +
  tm_polygons(
    fill = "avg_residual",
    # fill.scale = tm_scale_intervals(
    #   values = "RdBu",
    #   midpoint = 0,
    #   style = "fixed",
    #   breaks = c(-Inf, -10, -5, -2, 2, 5, 10, Inf)),
    fill.legend = tm_legend(title = "Avg Residual (Actual - Predicted)")) +
  add_map_decorations()

error_map
# tmap_save(error_map, filename = paste0("Data/Layout/residual_map_",cscale,".png", sep=''), width = 12, height = 6, dpi = 300)
```

# Spatial Temporal ARIMA result analysis

```{r}
hist(fit.star$RES[,1], main="Residuals for First Area")
Box.test(fit.star$RES[,1], lag=1, type="Ljung")
```

## Plot result

```{r}
matplot(cbind(pre.star$OBS[,1], pre.star$PRE[,1]), 
        type="l", lty=c(1,2), col=c("black", "red"),
        main="STARIMA: Actual (Black) vs Predicted (Red)")
```

## Compare two model

```{r}
actual_mat <- as.matrix(test_Z)
pred_mat <- as.matrix(pre.star$PRE)
n_rows <- min(nrow(actual_mat), nrow(pred_mat))

diff_mat <- tail(actual_mat, n_rows) - tail(pred_mat, n_rows)

star_mse_vec <- colMeans(diff_mat^2, na.rm = TRUE)

starima_metrics <- data.frame(
  lad22cd = names(star_mse_vec),
  mse_star = star_mse_vec)

st_svr_metrics <- analyse_final_all %>%
  st_drop_geometry() %>%
  group_by(!!sym(cscale)) %>%
  summarise(mse_svr = mean(mse, na.rm = TRUE))

model_comparison <- st_svr_metrics %>%
  left_join(starima_metrics, by = cscale)

model_comparison %>% st_drop_geometry()
```

```{r}
library(forcats)
plot_data <- model_comparison %>%
  # reorder lad22cd based on mse_scr
  mutate(lad22cd = fct_reorder(lad22cd, mse_svr)) %>%
  pivot_longer(cols = c(mse_svr, mse_star), 
               names_to = "Model", 
               values_to = "MSE") %>%
  mutate(Model = ifelse(Model == "mse_svr", "SVR", "STARIMA"))

ggplot(plot_data, aes(x = MSE, y = lad22cd)) +
  geom_line(aes(group = lad22cd), color = "gray80", size = 1) +
  geom_point(aes(color = Model), size = 1) +
  labs(title = "MSE by District: SVR vs STARIMA",
       x = "Mean Squared Error (MSE)",
       y = "District Code")
```
