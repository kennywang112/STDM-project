---
title: "Model_EDA"
format: html
editor: visual
---

# Spatial Temporal SVR result analysis

## Result for first 3 area

```{r}
top_msoa <- test_results %>%
  group_by(.data[[cscale]]) %>%
  summarise(total = sum(Actual)) %>%
  arrange(desc(total)) %>%
  slice(1:3) %>%
  pull(.data[[cscale]])

plot_subset <- test_results %>%
  filter(.data[[cscale]] %in% top_msoa)

ggplot(plot_subset, aes(x = time_date)) +
  geom_line(aes(y = Actual, group = .data[[cscale]], color = .data[[cscale]]), size = 0.5) +
  geom_line(aes(y = Predicted, group = .data[[cscale]], color = .data[[cscale]]), linetype = "dashed", size = 0.8) +
  facet_wrap(~.data[[cscale]], scales = "free_y", ncol = 1) +
  theme_minimal()
```

## Plot result

```{r}
analyse_final_all_stsvr <- test_results%>%
  mutate(
    mse = (Actual - Predicted)^2,
    mse_t = (Actual - Predicted_t)^2)%>%
  left_join(london_geom, by = cscale)%>%
  st_as_sf()

analyse_final_all_stgcn <- test_results_stgcn%>%
  mutate(
    mse = (Actual - Predicted_ann)^2,
    mse_t = (Actual - Predicted_stgcn)^2)%>%
  left_join(london_geom, by = cscale)%>%
  st_as_sf()

analyse_final_all <- analyse_final_all_stsvr
```

```{r}
predicted_line <- test_results%>%
  mutate(time_date = as.Date(time_date)) %>%
  group_by(time_date)%>%
  summarise(
    total_actual = sum(Actual), total_predicted = sum(Predicted), total_predicted_t = sum(Predicted_t))%>%
  ggplot(aes(x = time_date)) +
  geom_line(aes(y = total_actual, color = "Actual"), size = 0.5) +
  geom_line(aes(y = total_predicted, color = "Predicted"), linetype = "dashed", size = 0.8) +
  geom_line(aes(y = total_predicted_t, color = "Predicted_t"), linetype = "dashed", size = 0.8) +
  theme_minimal() +
  labs(title = "Total Actual vs Predicted Accidents Over Time", y = "Total Accidents", color = "Legend")
predicted_line
# ggsave(file = "Data/Layout/ST_SVR_result.png", predicted_line, width = 15, height = 6, dpi = 300)
```

## Residual

```{r}
mse_plot <- analyse_final_all%>%
  ggplot()+
  geom_line(aes(time_date, mse)) +
  theme_minimal() +
  labs(title = "MSE of SVR with Spatial Lag Over Time", x = "Time", y = "Mean Squared Error")
mse_plot
# ggsave(file = "Data/Layout/ST_SVR_mse.png", mse_plot, width = 15, height = 6, dpi = 300)
```

## Map

```{r}
library(tmap)
source('./utils/map_func.R')
spatial_error <- analyse_final_all %>%
  group_by(.data[[cscale]]) %>%
  summarise(
    avg_residual = mean(Actual - Predicted, na.rm = TRUE),
    geometry = st_union(geometry)) %>%
  st_as_sf()

tmap_mode('plot')
error_map <- tm_basemap("CartoDB.Positron") +
  tm_shape(spatial_error) +
  tm_polygons(
    fill = "avg_residual",
    # fill.scale = tm_scale_intervals(
    #   values = "RdBu",
    #   midpoint = 0,
    #   style = "fixed",
    #   breaks = c(-Inf, -10, -5, -2, 2, 5, 10, Inf)),
    fill.legend = tm_legend(title = "Avg Residual (Actual - Predicted)")) +
  add_map_decorations()

error_map
# tmap_save(error_map, filename = paste0("Data/Layout/residual_map_",cscale,".png", sep=''), width = 12, height = 6, dpi = 300)
```

# Spatial Temporal ARIMA result analysis

```{r}
hist(fit.star$RES[,1], main="Residuals for First Area")
Box.test(fit.star$RES[,1], lag=1, type="Ljung")
```

## Plot result

```{r}
matplot(cbind(pre.star$OBS[,2], pre.star$PRE[,2]), 
        type="l", lty=c(1,2), col=c("black", "red"),
        main="STARIMA: Actual (Black) vs Predicted (Red)")
```

# ST GCN

```{r}
top_msoa <- test_results_stgcn %>%
  group_by(.data[[cscale]]) %>%
  summarise(total = sum(Actual)) %>%
  arrange(desc(total)) %>%
  slice(1:3) %>%
  pull(.data[[cscale]])

plot_subset <- test_results_stgcn %>%
  filter(.data[[cscale]] %in% top_msoa)

ggplot(plot_subset, aes(x = time_date)) +
  geom_line(aes(y = Actual, group = .data[[cscale]], color = .data[[cscale]]), size = 0.5) +
  geom_line(aes(y = Predicted_stgcn, group = .data[[cscale]], color = .data[[cscale]]), linetype = "dashed", size = 0.8) +
  facet_wrap(~.data[[cscale]], scales = "free_y", ncol = 1) +
  theme_minimal()
```

```{r}
analyse_final_all_gcn <- test_results_stgcn%>%
  mutate(
    mse_ann = (Actual - Predicted_ann)^2,
    mse_stgcn = (Actual - Predicted_stgcn)^2)%>%
  left_join(london_geom, by = cscale)%>%
  st_as_sf()

predicted_line <- test_results_stgcn%>%
  mutate(time_date = as.Date(time_date)) %>%
  group_by(time_date)%>%
  summarise(total_actual = sum(Actual), total_predicted_ann = sum(Predicted_ann), total_predicted_stgcn = sum(Predicted_stgcn))%>%
  ggplot(aes(x = time_date)) +
  geom_line(aes(y = total_actual, color = "Actual"), size = 0.5) +
  geom_line(aes(y = total_predicted_ann, color = "Predicted SGCN"), linetype = "dashed", size = 0.8) +
  geom_line(aes(y = total_predicted_stgcn, color = "Predicted STGCN"), linetype = "dashed", size = 0.8) +
  theme_minimal() +
  labs(title = "Total Actual vs Predicted Accidents Over Time", y = "Total Accidents", color = "Legend")
predicted_line
```

# Compare Three models

```{r}
stsvr_metrics <- analyse_final_all %>%
  st_drop_geometry() %>%
  group_by(!!sym(cscale)) %>%
  summarise(mse_svr = mean(mse, na.rm = TRUE))

model_comparison <- stsvr_metrics %>%
  left_join(starima_metrics, by = cscale)

test_results_combined <- test_results %>%
  mutate(
    Predicted_ANN = test_results_stgcn$Predicted_ann,
    Predicted_STGCN = test_results_stgcn$Predicted_stgcn
  )
aggregate_all_models <- test_results_combined %>%
  mutate(
    mse = (Predicted - Actual)^2,
    mse_t = (Predicted_t - Actual)^2, 
    mse_ann = (Predicted_ANN - Actual)^2, 
    mse_stgcn = (Predicted_STGCN - Actual)^2) %>%
  group_by(time_date) %>%
  summarise(
    actual_sum = sum(Actual), 
    mse_stsvr_mean = mean(mse), predict_stsvr = sum(Predicted),
    mse_tsvr_mean = mean(mse_t), predict_tsvr = sum(Predicted_t),
    mse_stgcn_mean = mean(mse_stgcn), predict_stgcn = sum(Predicted_STGCN),
    mse_ann_mean = mean(mse_ann), predict_ann = sum(Predicted_ANN)) %>%
  slice(-1) %>%
  mutate(
    predict_starima = predict_starima, mse_starima_mean = mse_per_time,
    predict_arima = predict_arima, mse_arima_mean = pred_se
  )
```

```{r}
compare_plot <- aggregate_all_models %>%
  mutate(time_date = as.Date(time_date)) %>%
  ggplot() +
  geom_line(aes(x=time_date, y=actual_sum, color="Actual"), size=1) +
  geom_line(aes(x=time_date, y=predict_stsvr, color="STSVR"), size=1, linetype = "dashed") +
  geom_line(aes(x=time_date, y=predict_tsvr, color="TSVR"), size=1, linetype = "dashed") +
  geom_line(aes(x=time_date, y=predict_starima, color="STARIMA"), size=1, linetype = "dashed") +
  geom_line(aes(x=time_date, y=predict_arima, color="ARIMA"), size=1, linetype = "dashed") +
  geom_line(aes(x=time_date, y=predict_stgcn, color="STGCN"), size=1, linetype = "dashed") +
  geom_line(aes(x=time_date, y=predict_ann, color="ANN"), size=1, linetype = "dashed") +
  scale_color_manual(name = "Type",
                     values = c("Actual" = "#1e23b3", 
                                "STSVR" = "#63e0ff", "TSVR" = "#25b7db",
                                "STARIMA" = "#2fad6e", "ARIMA" = "#1a633f",
                                "ANN" = "#d465d6", "STGCN" = "#9b819c")) +
  labs(title="Model Prediction", y="Accidents") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

compare_plot
ggsave(file = "./Data/Layout/time_based_two_model_compare.png", compare_plot, width = 12, height = 6, dpi = 300)
```

```{r}
avg_mse_svr <- round(mean(aggregate_all_models$mse_stsvr_mean, na.rm = TRUE) * 100, 10)
avg_mse_tsvr <- round(mean(aggregate_all_models$mse_tsvr_mean, na.rm = TRUE) * 100, 10)
avg_mse_starima <- round(mean(aggregate_all_models$mse_starima_mean, na.rm = TRUE) * 100, 10)
avg_mse_arima <- round(mean(aggregate_all_models$mse_arima_mean, na.rm = TRUE) * 100, 10)
avg_mse_stgcn <- round(mean(aggregate_all_models$mse_stgcn_mean, na.rm = TRUE) * 100, 510)
avg_mse_ann <- round(mean(aggregate_all_models$mse_ann_mean, na.rm = TRUE) * 100, 10)

# create table for MSE
tb <- tibble(
  Model = c("STSVR", "TSVR", "STARIMA", "ARIMA", "ANN", "TGCN"),
  MSE = c(avg_mse_svr, avg_mse_tsvr, avg_mse_starima, avg_mse_arima, avg_mse_stgcn, avg_mse_ann),
)
tb

```
